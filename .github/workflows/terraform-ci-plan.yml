name: Homelab CI/CD Workflow
run-name: "Terraform Plan (CI) - ${{ github.ref_name }}" 
on:
  pull_request:
    types: [opened, reopened, synchronize]  
    paths-ignore:
      - '**/*.md'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  detect-terraform-directory:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code    
        uses: actions/checkout@v4
        
      - name: Find changed Terraform directories
        id: find_tf_changes
        run: |
          # Get list of changed files between commits
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
      
          # Filter for .tf files
          TF_FILES=$(echo "$CHANGED_FILES" | grep '\.tf$' || true)
      
          if [ -z "$TF_FILES" ]; then
            echo "No Terraform files changed."
            echo "dir=" >> $GITHUB_OUTPUT
            exit 0
          fi
      
          # Extract unique directories
          TF_DIRS=$(echo "$TF_FILES" | xargs -n1 dirname | sort -u)
      
          # Pick the first directory (or handle multiple if needed)
          TF_DIR=$(echo "$TF_DIRS" | head -n 1)
      
          # Export to environment and output
          echo "TF_DIR=$TF_DIR" >> $GITHUB_ENV
          echo "dir=$TF_DIR" >> $GITHUB_OUTPUT
          echo "Detected Terraform directory: $TF_DIR"
